---

- name: Fetch signing key for Jitsi repository
  apt_key:
    id: "66A9CD0595D6AFA247290D3BEF8B479E2DC1389C"
    url: "https://download.jitsi.org/jitsi-key.gpg.key"
    state: present

- name: Add Jitsi repository
  apt_repository:
    repo: "deb https://download.jitsi.org/ stable/"
    state: present

- name: Derive individual secrets from base secret
  set_fact:
    "{{ item }}": "{{ (jitsi_meet_base_secret | string + item) | password_hash('sha512')| replace('/', '') | reverse | truncate(32, end='') }}"
  loop:
    - jitsi_meet_videobridge_secret
    - jitsi_meet_videobridge_password
    - jitsi_meet_jicofo_secret
    - jitsi_meet_jicofo_password
    - jitsi_meet_turn_secret

- name: Derive videobridge nickname
  set_fact:
    jitsi_meet_videobridge_muc_nickname: "{{ (jitsi_meet_base_secret | string + 'jvb_muc_nick') | to_uuid }}"

- name: Set debconf options for jitsi-meet
  debconf:
    name: "{{ item.name }}"
    question: "{{ item.question }}"
    value: "{{ item.value }}"
    vtype: "{{ item.vtype }}"
  loop:
    - name: jitsi-videobridge2
      question: jitsi-videobridge/jvb-hostname
      value: "{{ jitsi_meet_server_name }}"
      vtype: string
    - name: jitsi-meet-web-config
      question: jitsi-meet/cert-choice
      value: "{{ jitsi_meet_cert_choice }}"
      vtype: string
    - name: jitsi-meet-web-config
      question: jitsi-meet/cert-path-crt
      value: "{{ jitsi_meet_ssl_cert_path }}"
      vtype: string
    - name: jitsi-meet-web-config
      question: jitsi-meet/cert-path-key
      value: "{{ jitsi_meet_ssl_key_path }}"
      vtype: string
    - name: jitsi-meet-prosody
      question: jitsi-meet-prosody/turn-secret
      value: "{{ jitsi_meet_turn_secret }}"
      vtype: string

- include: prosody.yml
- include: jitsi-meet.yml
- include: ui_customization.yml
- include: nginx.yml

- name: Generate logrotate configs
  template:
    src: logrotate.d/{{ item }}.j2
    dest: /etc/logrotate.d/{{ item }}
    owner: root
    group: root
    mode: 0644
  loop:
    - jicofo
    - jitsi-videobridge
    - nginx
    - prosody
